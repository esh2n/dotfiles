# Directory management
function mkdir_and_change_directory() {
  if [ $# -eq 0 ]; then
    echo "‚ùå Error: Directory name required"
    echo "Usage: mkcd <directory>"
    return 1
  fi

  for dir in "$@"; do
    if [ -d "$dir" ]; then
      echo "‚ö†Ô∏è  Directory '$dir' already exists"
      echo "‚û°Ô∏è  Change to this directory? [Y/n]: "
      read -r response
      case "$response" in
        [nN]*)
          continue
          ;;
        *)
          cd "$dir" || return 1
          echo "‚úÖ Changed to '$dir'"
          return 0
          ;;
      esac
    else
      if mkdir -p "$dir" 2>/dev/null; then
        echo "‚ú® Created directory '$dir'"
        cd "$dir" || return 1
        echo "‚úÖ Changed to '$dir'"
        return 0
      else
        echo "‚ùå Error: Failed to create '$dir'"
        echo "üí° Check directory permissions"
        return 1
      fi
    fi
  done
}

# Vim mode indicator
function zle-line-init zle-keymap-select {
  RPS1="${${KEYMAP/vicmd/-- NORMAL --}/(main|viins)/-- INSERT --}"
  RPS2=${RPS1}
  zle reset-prompt
}

# Fuzzy finder functions
function sk_select_history() {
  BUFFER=$(history -n -r 1 | sk --ansi --reverse --height '50%' --query "$LBUFFER")
  CURSOR=$#BUFFER
  zle clear-screen
}

function sk_select_src () {
  # Áõ¥Êé•ÂÆüË°å„Å®„Ç¶„Ç£„Ç∏„Çß„ÉÉ„ÉàÂëº„Å≥Âá∫„Åó„ÅÆ‰∏°Êñπ„Å´ÂØæÂøú
  if [[ "$1" = "--direct" ]]; then
    # Áõ¥Êé•„Ç≥„Éû„É≥„Éâ„Å®„Åó„Å¶ÂÆüË°åÔºàZLEÈùû‰æùÂ≠òÔºâ
    local direct_mode=1
  elif [[ ! -o zle ]]; then
    # ZLE„ÅåÁÑ°Âäπ„Åß„ÄÅ„Åã„Å§Áõ¥Êé•„Ç≥„Éû„É≥„Éâ„Å®„Åó„Å¶„ÇÇÂÆüË°å„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà
    echo "sk_select_src„ÇíÁõ¥Êé•ÂÆüË°å„Åó„Åæ„ÅôÔºàZLE„ÅåÁÑ°Âäπ„Å™„Åü„ÇÅÔºâ"
    sk_select_src --direct
    return $?
  fi

  # SIGINTÔºàCtrl+CÔºâ„Éè„É≥„Éâ„É©„ÇíË®≠ÂÆöÔºà‰∏≠Êñ≠ÊôÇ„ÅÆ„Ç¥„Éü„Éï„Ç°„Ç§„É´Âá¶ÁêÜ„ÇíÈò≤Ê≠¢Ôºâ
  # original„ÅÆ„Éè„É≥„Éâ„É©„Çí‰øùÂ≠ò
  local original_sigint_handler=$(trap -p INT)
  
  # Èñ¢Êï∞ÁµÇ‰∫ÜÊôÇ„Å´SIGINT„Éè„É≥„Éâ„É©„ÇíÂÖÉ„Å´Êàª„ÅôÈñ¢Êï∞
  function cleanup() {
    # ÂÖÉ„ÅÆSIGINT„Éè„É≥„Éâ„É©„ÇíÂæ©ÂÖÉÔºàÂ≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºâ
    if [[ -n "$original_sigint_handler" ]]; then
      eval "$original_sigint_handler"
    else
      trap - INT
    fi
    # „Éá„Éê„ÉÉ„Ç∞Áî®„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÁÑ°ÂäπÂåñÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶„Ç≥„É°„É≥„ÉàËß£Èô§Ôºâ
    # echo "sk_select_src: „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü"
  }
  
  # ÁµÇ‰∫ÜÊôÇ„Å´ÂøÖ„Åö„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„ÇíÂÆüË°å
  trap cleanup EXIT
  
  # Ctrl+CÊäº‰∏ãÊôÇ„ÅÆÁã¨Ëá™Âá¶ÁêÜÔºà‰∏≠Êñ≠„Çí„Åç„Çå„ÅÑ„Å´Âá¶ÁêÜÔºâ
  trap "cleanup; return 130" INT

  local selected_dir=""
  
  # pacifica„ÇíÂÑ™ÂÖàÁöÑ„Å´‰ΩøÁî®ÔºàWSLÁí∞Â¢É„Åß„ÇÇÔºâ
  if command -v pacifica &>/dev/null; then
    # sk„Ç≥„Éû„É≥„Éâ„ÅÆÂ≠òÂú®Á¢∫Ë™ç
    if ! command -v sk &>/dev/null; then
      echo "„Ç®„É©„Éº: sk„Ç≥„Éû„É≥„Éâ„Åå„Ç§„É≥„Çπ„Éà„Éº„É´„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì"
      echo "WSLÁí∞Â¢É„Åß„ÅØ: sudo apt install skim"
      zle reset-prompt
      return 1
    fi
    
    # Èùô„Åã„Å´ÂÆüË°åÔºà‰ΩôË®à„Å™„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫„Åó„Å™„ÅÑÔºâ
    local output
    output=$(pacifica 2>/dev/null)
    
    # Âá∫Âäõ„ÅåÁ©∫„Åß„Å™„ÅÑ„Åì„Å®„ÇíÁ¢∫Ë™ç
    if [[ -n "$output" ]]; then
      # sk„Å´Ê∏°„Åó„Å¶ÈÅ∏Êäû
      selected_dir=$(echo "$output" | sk --ansi --reverse --height '50%' --query "$LBUFFER" 2>/dev/null)
    else
      # Èùô„Åã„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
      if command -v fd &>/dev/null; then
        selected_dir=$(fd --type d --hidden --exclude .git --exclude node_modules . "$HOME" 2>/dev/null | sk --ansi --reverse --height '50%' --query "$LBUFFER" 2>/dev/null)
      elif command -v find &>/dev/null; then
        selected_dir=$(find "$HOME" -type d -not -path "*/\.*" -not -path "*/node_modules/*" 2>/dev/null | sk --ansi --reverse --height '50%' --query "$LBUFFER" 2>/dev/null)
      fi
    fi
  else
    # pacifica„Åå„Ç§„É≥„Çπ„Éà„Éº„É´„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØfd„Åæ„Åü„ÅØfind„Çí‰ΩøÁî®ÔºàÈùô„Åã„Å´Ôºâ
    if command -v fd &>/dev/null; then
      selected_dir=$(fd --type d --hidden --exclude .git --exclude node_modules . "$HOME" 2>/dev/null | sk --ansi --reverse --height '50%' --query "$LBUFFER" 2>/dev/null)
    elif command -v find &>/dev/null; then
      selected_dir=$(find "$HOME" -type d -not -path "*/\.*" -not -path "*/node_modules/*" 2>/dev/null | sk --ansi --reverse --height '50%' --query "$LBUFFER" 2>/dev/null)
    else
      echo "„Ç®„É©„Éº: pacifica„ÄÅfd„ÄÅfind„ÅÆ„ÅÑ„Åö„Çå„ÇÇ„Ç§„É≥„Çπ„Éà„Éº„É´„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì"
      zle reset-prompt
      return 1
    fi
  fi

  # ÈÅ∏Êäû„Åó„Åü„Éá„Ç£„É¨„ÇØ„Éà„É™„ÅåÂ≠òÂú®„Åô„Çå„Å∞ÁßªÂãï
  if [ -n "$selected_dir" ]; then
    if [[ "$direct_mode" = "1" ]]; then
      # Áõ¥Êé•„É¢„Éº„Éâ: „Ç≥„Éû„É≥„Éâ„Å®„Åó„Å¶ÂÆüË°å
      cd "${selected_dir}"
      echo "‚úì ÁßªÂãïÂÖà: ${selected_dir}"
    else
      # ZLE„É¢„Éº„Éâ: „Ç¶„Ç£„Ç∏„Çß„ÉÉ„Éà„Å®„Åó„Å¶ÂÆüË°å
      BUFFER="cd ${selected_dir}"
      zle accept-line
    fi
  else
    if [[ "$direct_mode" != "1" && -o zle ]]; then
      zle reset-prompt
    else
      echo "„Éá„Ç£„É¨„ÇØ„Éà„É™„ÅåÈÅ∏Êäû„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü"
    fi
  fi
}

function sk_change_directory() {
  # ZLE„ÅåÊúâÂäπ„Åã„Å©„ÅÜ„Åã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
  if [[ ! -o zle ]]; then
    echo "„Ç®„É©„Éº: „É©„Ç§„É≥Á∑®ÈõÜ„ÅåÊúâÂäπ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Ç∑„Çß„É´„ÅßÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
    return 1
  fi

  # SIGINTÔºàCtrl+CÔºâ„Éè„É≥„Éâ„É©„ÇíË®≠ÂÆö
  local original_sigint_handler=$(trap -p INT)
  
  # Èñ¢Êï∞ÁµÇ‰∫ÜÊôÇ„Å´SIGINT„Éè„É≥„Éâ„É©„ÇíÂÖÉ„Å´Êàª„ÅôÈñ¢Êï∞
  function cleanup() {
    if [[ -n "$original_sigint_handler" ]]; then
      eval "$original_sigint_handler"
    else
      trap - INT
    fi
  }
  
  # ÁµÇ‰∫ÜÊôÇ„Å´ÂøÖ„Åö„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„ÇíÂÆüË°å
  trap cleanup EXIT
  
  # Ctrl+CÊäº‰∏ãÊôÇ„ÅÆÁã¨Ëá™Âá¶ÁêÜ
  trap "cleanup; return 130" INT

  # zoxide„Ç≥„Éû„É≥„Éâ„ÅåÂ≠òÂú®„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
  if ! command -v zoxide &>/dev/null; then
    echo "„Ç®„É©„Éº: zoxide„Åå„Ç§„É≥„Çπ„Éà„Éº„É´„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ"
    echo "install-wsl-packages.sh„ÇíÂÆüË°å„Åô„Çã„Åã„ÄÅ‰ª•‰∏ã„ÅÆ„Ç≥„Éû„É≥„Éâ„Åß„Ç§„É≥„Çπ„Éà„Éº„É´„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö"
    echo "sudo apt install zoxide"
    return 1
  fi

  local output=$(zoxide query -l)
  local selected_dir=""
  
  if [[ -n "$output" ]]; then
    selected_dir=$(echo "$output" | sk --ansi --reverse --height '50%' 2>/dev/null)
  fi
  
  if [ -n "$selected_dir" ]; then
    BUFFER="cd ${selected_dir}"
    zle accept-line
  fi
}

function sk_select_file_below_pwd() {
  # ZLE„ÅåÊúâÂäπ„Åã„Å©„ÅÜ„Åã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
  if [[ ! -o zle ]]; then
    echo "„Ç®„É©„Éº: „É©„Ç§„É≥Á∑®ÈõÜ„ÅåÊúâÂäπ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Ç∑„Çß„É´„ÅßÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
    return 1
  fi

  # SIGINTÔºàCtrl+CÔºâ„Éè„É≥„Éâ„É©„ÇíË®≠ÂÆö
  local original_sigint_handler=$(trap -p INT)
  
  # Èñ¢Êï∞ÁµÇ‰∫ÜÊôÇ„Å´SIGINT„Éè„É≥„Éâ„É©„ÇíÂÖÉ„Å´Êàª„ÅôÈñ¢Êï∞
  function cleanup() {
    if [[ -n "$original_sigint_handler" ]]; then
      eval "$original_sigint_handler"
    else
      trap - INT
    fi
  }
  
  # ÁµÇ‰∫ÜÊôÇ„Å´ÂøÖ„Åö„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„ÇíÂÆüË°å
  trap cleanup EXIT
  
  # Ctrl+CÊäº‰∏ãÊôÇ„ÅÆÁã¨Ëá™Âá¶ÁêÜ
  trap "cleanup; return 130" INT

  if [ ! `pwd | grep "$(ghq root)"` ]; then
    echo "you are not in ghq path"
    zle accept-line
    return 0
  fi
  
  local selected_path=""
  
  # fd„Ç≥„Éû„É≥„Éâ„ÅÆÂá∫Âäõ„ÇíÂ§âÊï∞„Å´‰øùÂ≠ò„Åó„Å¶„Åã„Çâsk„Å´Ê∏°„Åô
  local files_list=$(fd --type f --hidden --exclude .git --exclude node_modules --exclude vendor 2>/dev/null)
  
  if [[ -n "$files_list" ]]; then
    selected_path=$(echo "$files_list" | sk --ansi --reverse --height '50%' --preview 'bat --style=numbers --color=always {}' 2>/dev/null)
  fi
  
  if [ -n "$selected_path" ]; then
    go_to "$selected_path"
  fi
}

function sk_select_file_within_project() {
  # ZLE„ÅåÊúâÂäπ„Åã„Å©„ÅÜ„Åã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
  if [[ ! -o zle ]]; then
    echo "„Ç®„É©„Éº: „É©„Ç§„É≥Á∑®ÈõÜ„ÅåÊúâÂäπ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Ç∑„Çß„É´„ÅßÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
    return 1
  fi

  # SIGINTÔºàCtrl+CÔºâ„Éè„É≥„Éâ„É©„ÇíË®≠ÂÆö
  local original_sigint_handler=$(trap -p INT)
  
  # Èñ¢Êï∞ÁµÇ‰∫ÜÊôÇ„Å´SIGINT„Éè„É≥„Éâ„É©„ÇíÂÖÉ„Å´Êàª„ÅôÈñ¢Êï∞
  function cleanup() {
    if [[ -n "$original_sigint_handler" ]]; then
      eval "$original_sigint_handler"
    else
      trap - INT
    fi
  }
  
  # ÁµÇ‰∫ÜÊôÇ„Å´ÂøÖ„Åö„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„ÇíÂÆüË°å
  trap cleanup EXIT
  
  # Ctrl+CÊäº‰∏ãÊôÇ„ÅÆÁã¨Ëá™Âá¶ÁêÜ
  trap "cleanup; return 130" INT

  local base_path=$(pwd | grep -o "$(ghq root)/[^/]*/[^/]*/[^/]*")
  if [ -z "$base_path" ]; then
    echo "you are not in ghq project"
    zle accept-line
    return 0
  fi
  
  # fd„Ç≥„Éû„É≥„Éâ„ÅÆÂá∫Âäõ„ÇíÂ§âÊï∞„Å´‰øùÂ≠ò
  local paths=$(fd --type f --hidden --exclude .git --exclude node_modules --exclude vendor . "$base_path" 2>/dev/null)
  
  # fd„Ç≥„Éû„É≥„Éâ„ÅÆÂá∫Âäõ„ÅåÁ©∫„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åøsk„Å´Ê∏°„Åô
  if [[ -n "$paths" ]]; then
    local selected_path="$(echo "(root)"$'\n'"$paths" | sk --ansi --reverse --height '50%' --preview 'bat --style=numbers --color=always {} 2>/dev/null || echo "Preview not available"' 2>/dev/null)"
    
    if [ -n "$selected_path" ]; then
      if [[ "$selected_path" = "(root)" ]]; then
        go_to "$base_path"
        return 0
      fi
      go_to "$selected_path"
    fi
  else
    echo "„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂÜÖ„Å´„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"
    zle reset-prompt
  fi
}

function go_to() {
  if [ -f "$1" ]; then
    nvim "$1"
    dir_path=$(dirname "$1")
    BUFFER="cd \"$dir_path\""
  elif [ -d "$1" ]; then
    BUFFER="cd \"$1\""
  else
    echo "selected path is neither file nor directory"
  fi
  zle accept-line
}

function sk_edit_file() {
  local selected_path=$(fd --type f --hidden --exclude .git | sk --ansi --reverse --height '50%' --preview 'bat --style=numbers --color=always {}')
  if [ -n "$selected_path" ]; then
    nvim "$selected_path"
  fi
}

# Git branch selection
function sk_select_branch_except_current() {
  git branch -a --sort=-authordate | \
    grep -v -e '->' -e '*' | \
    sed "s/remotes\/origin\///g" | \
    awk '!a[$0]++' | \
    sk --ansi --reverse --height '50%'
}

function sk_select_local_branch_except_current() {
  git branch | \
    grep -v -e '->' -e '*' | \
    sed "s/remotes\/origin\///g" | \
    awk '!a[$0]++' | \
    sk --ansi --reverse --height '50%'
}

function sk_select_branch_all() {
  git branch -a --sort=-authordate | \
    grep -v -e '->' | \
    sed "s/remotes\/origin\///g" | \
    sed "s/\*/ /g" | \
    awk '!a[$0]++' | \
    sk --ansi --reverse --height '50%'
}

# Tmux
function precmd() {
  if [ ! -z $TMUX ]; then
    tmux refresh-client -S
  fi
}

# Font installation
function nerd_fonts() {
  git clone --branch=master --depth 1 https://github.com/ryanoasis/nerd-fonts.git
  cd nerd-fonts
  ./install.sh $1
  cd ..
  rm -rf nerd-fonts
}

# Cross-platform open command (works in macOS, Linux, and WSL)
function open() {
  # Check if arguments were provided
  if [[ $# -eq 0 ]]; then
    echo "‚ùå Error: Missing argument"
    echo "Usage: open <file or URL>"
    return 1
  fi

  local target="$1"
  
  # Detect platform and use appropriate command
  if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS - use native open command
    command open "$@"
  elif grep -q Microsoft /proc/version 2>/dev/null; then
    # WSL - handle with special care
    
    # Check for directory specifically
    if [[ -d "$target" ]]; then
      # Directory handling in WSL
      if command -v wslview >/dev/null 2>&1; then
        # Use wslview for directories (best option)
        wslview "$target"
      elif command -v wslpath >/dev/null 2>&1; then
        # Convert path to Windows and use explorer directly
        local winpath=$(wslpath -w "$target")
        explorer.exe "$winpath"
      else
        # Last resort - just try explorer with path
        explorer.exe "$target"
        echo "‚ö†Ô∏è Warning: For better directory handling, install wslu:"
        echo "    sudo apt install -y wslu"
      fi
    else
      # Files and URLs handling
      if command -v wslview >/dev/null 2>&1; then
        wslview "$target"
      else
        # Convert path to Windows format if it's a file path
        if [[ -e "$target" ]]; then
          local winpath=$(wslpath -w "$target")
          explorer.exe "$winpath"
        else
          # If it's a URL or doesn't exist as a file, pass directly
          explorer.exe "$target"
        fi
        echo "üí° Tip: Install wslu package for better Windows integration:"
        echo "    sudo apt install -y wslu"
      fi
    fi
    
    # Check for locale issues and provide helpful message
    if grep -q "warning: Setting locale failed" <<< "$(locale 2>&1)"; then
      echo ""
      echo "‚ö†Ô∏è Locale Warning: You have locale issues in your environment."
      echo "üìù Run the utility setup script to resolve these warnings:"
      echo "    sh ~/go/github.com/esh2n/dotfiles/linux-utils-setup.sh"
    fi
  else
    # Regular Linux - use xdg-open
    if command -v xdg-open >/dev/null 2>&1; then
      xdg-open "$target"
      
      # Check for specific directory error
      if [[ $? -ne 0 && -d "$target" ]]; then
        echo "‚ö†Ô∏è Warning: xdg-open failed to open directory."
        echo "üí° Install desktop-file-utils and required applications:"
        echo "    sudo apt install -y desktop-file-utils xdg-utils"
        echo "    sudo update-desktop-database"
        
        # Try to fall back to a file manager if available
        for fm in nautilus thunar dolphin pcmanfm caja nemo; do
          if command -v $fm >/dev/null 2>&1; then
            echo "üîÑ Trying to open with $fm instead..."
            $fm "$target"
            return $?
          fi
        done
      fi
    else
      echo "‚ùå Error: No suitable 'open' command found"
      echo "üí° Install xdg-utils package:"
      echo "    sudo apt install -y xdg-utils"
      return 1
    fi
  fi
}

# GCloud functions
function gcloud-activate() {
  name="$1"
  project="$2"
  echo "gcloud config configurations activate \"${name}\""
  gcloud config configurations activate "${name}"
}

function gx-complete() {
  _values $(gcloud config configurations list | awk '{print $1}')
}

function gx() {
  name="$1"
  if [ -z "$name" ]; then
    line=$(gcloud config configurations list | sk --ansi --reverse --height '50%')
    name=$(echo "${line}" | awk '{print $1}')
  else
    line=$(gcloud config configurations list | grep "$name")
  fi
  project=$(echo "${line}" | awk '{print $4}')
  gcloud-activate "${name}" "${project}"
}
compdef gx-complete gx

# Bind keys for fuzzy finder (Áí∞Â¢ÉÈÅ©ÂøúÂûã)
if [[ $- == *i* ]]; then
  # „Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Ç∑„Çß„É´„ÅÆÂ†¥Âêà„ÅÆ„Åø„Ç≠„Éº„Éê„Ç§„É≥„Éâ„ÇíË®≠ÂÆö
  # „Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Ç∑„Çß„É´„Åß„ÇÇZLE„ÅåÁÑ°Âäπ„Å™Â†¥Âêà„ÅÆ„Åü„ÇÅ„Å´„ÄÅ„Ç≥„Éû„É≥„Éâ„Ç®„Ç§„É™„Ç¢„Çπ„ÇÇË®≠ÂÆö
  
  # ZLE„ÅåÊúâÂäπ„Å™Â†¥Âêà„ÅÆ„Åø„ÄÅ„Ç¶„Ç£„Ç∏„Çß„ÉÉ„ÉàÁôªÈå≤„Å®„Ç≠„Éº„Éê„Ç§„É≥„ÉâË®≠ÂÆö„ÇíË°å„ÅÜ
  if [[ -o zle ]]; then
    # ÂÖ®„Å¶„ÅÆskÈñ¢ÈÄ£„ÅÆÈñ¢Êï∞„Çí„Ç¶„Ç£„Ç∏„Çß„ÉÉ„Éà„Å®„Åó„Å¶ÁôªÈå≤
    zle -N sk_select_history 2>/dev/null
    zle -N sk_select_src 2>/dev/null
    zle -N sk_change_directory 2>/dev/null
    zle -N sk_select_file_within_project 2>/dev/null
    zle -N sk_select_file_below_pwd 2>/dev/null
    
    # WSLÁí∞Â¢É„Åß„ÅÆ„Ç≠„Éº„Éê„Ç§„É≥„ÉâË®≠ÂÆö
    if [ "$IS_WSL" = "1" ]; then
      echo "WSLÁí∞Â¢ÉÁî®„Ç≠„Éº„Éê„Ç§„É≥„Éâ„ÇíË®≠ÂÆö„Åó„Å¶„ÅÑ„Åæ„Åô..."
      
      # ÈÅÖÂª∂„Ç≠„Éº„Éê„Ç§„É≥„ÉâË®≠ÂÆöÁî®„ÅÆÈñ¢Êï∞„ÇíÂÆöÁæ©
      function __setup_wsl_keybinds() {
        # Âü∫Êú¨„ÅÆ„Ç≠„Éº„Éê„Ç§„É≥„Éâ
        bindkey '^r' sk_select_history   # Ctrl+R: Â±•Ê≠¥Ê§úÁ¥¢
        bindkey '^g' sk_change_directory # Ctrl+G: „Éá„Ç£„É¨„ÇØ„Éà„É™Â§âÊõ¥
        
        # ‰ª£Êõø„Ç≠„Éº„Éê„Ç§„É≥„ÉâÔºàCtrl+]„ÅØnormal„É¢„Éº„Éâ„ÅÆÂàáÊõø„Å´‰ΩøÁî®„Åï„Çå„Çã„Åü„ÇÅÔºâ
        bindkey '^\' sk_select_src       # Ctrl+\
        bindkey '^p' sk_select_src       # Ctrl+P
        bindkey '\e]' sk_select_src      # Alt+]
        
        # ÂèØËÉΩ„Åß„ÅÇ„Çå„Å∞„ÄÅvim„É¢„Éº„Éâ„ÅÆinsert„É¢„Éº„Éâ„Åß„ÇÇCtrl+]„ÇíË®≠ÂÆö
        bindkey -M viins '^]' sk_select_src 2>/dev/null || true
      }
      
      # ÂÆâÂÖ®„Å´ÂàùÊúüË®≠ÂÆö„ÇíÂÆüË°å
      __setup_wsl_keybinds
      
      # ËøΩÂä†„ÅÆ„Ç≠„Éº„Éê„Ç§„É≥„Éâ
      bindkey '^v' sk_select_file_within_project  # Ctrl+V
      bindkey '^b' sk_select_file_below_pwd       # Ctrl+B
      
      # WSLÁí∞Â¢É„Åß„ÅÆ„Ç≠„Éº„Éê„Ç§„É≥„Éâ‰∏ÄË¶ß„ÇíË°®Á§∫
      cat <<EOF

======= WSLÁí∞Â¢ÉÁî®„Ç≠„Éº„Éê„Ç§„É≥„Éâ =======
Ctrl+R : Â±•Ê≠¥Ê§úÁ¥¢
Ctrl+G : „Éá„Ç£„É¨„ÇØ„Éà„É™Â§âÊõ¥
Ctrl+\\ : „ÇΩ„Éº„Çπ„Éá„Ç£„É¨„ÇØ„Éà„É™ÈÅ∏Êäû
Alt+] : „ÇΩ„Éº„Çπ„Éá„Ç£„É¨„ÇØ„Éà„É™ÈÅ∏Êäû
Ctrl+P : „ÇΩ„Éº„Çπ„Éá„Ç£„É¨„ÇØ„Éà„É™ÈÅ∏Êäû
Ctrl+V : „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂÜÖ„Éï„Ç°„Ç§„É´ÈÅ∏Êäû
Ctrl+B : ÁèæÂú®„Éá„Ç£„É¨„ÇØ„Éà„É™‰ª•‰∏ã„ÅÆ„Éï„Ç°„Ç§„É´ÈÅ∏Êäû

„Ç≥„Éû„É≥„Éâ: src ‚Üí „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Ç£„É¨„ÇØ„Éà„É™ÈÅ∏ÊäûÔºàZLE„Ç®„É©„ÉºÊôÇÔºâ
„Ç≥„Éû„É≥„Éâ: pd ‚Üí „Ç´„É¨„É≥„Éà„Éá„Ç£„É¨„ÇØ„Éà„É™‰ª•‰∏ã„ÅÆ„Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÔºàZLE„Ç®„É©„ÉºÊôÇÔºâ
================================

EOF
    else
      # macOS / ÈÄöÂ∏∏LinuxÁí∞Â¢ÉÁî®„ÅÆ„Ç≠„Éº„Éê„Ç§„É≥„ÉâË®≠ÂÆöÈñ¢Êï∞
      function __setup_macos_keybinds() {
        bindkey '^r' sk_select_history
        bindkey '^]' sk_select_src
        bindkey '^g' sk_change_directory
        bindkey '^v' sk_select_file_within_project
        bindkey '^b' sk_select_file_below_pwd
        
        # vim„É¢„Éº„Éâ„Åß„ÇÇ„Ç≠„Éº„Éê„Ç§„É≥„Éâ„ÇíË®≠ÂÆö
        bindkey -M viins '^]' sk_select_src 2>/dev/null || true
        bindkey -M vicmd '^]' sk_select_src 2>/dev/null || true
      }
      
      # ÂÆâÂÖ®„Å´ÂàùÊúüË®≠ÂÆö„ÇíÂÆüË°å
      __setup_macos_keybinds
      
      cat <<EOF

======= Ê®ôÊ∫ñ„Ç≠„Éº„Éê„Ç§„É≥„Éâ =======
Ctrl+R : Â±•Ê≠¥Ê§úÁ¥¢
Ctrl+] : „ÇΩ„Éº„Çπ„Éá„Ç£„É¨„ÇØ„Éà„É™ÈÅ∏Êäû
Ctrl+G : „Éá„Ç£„É¨„ÇØ„Éà„É™Â§âÊõ¥
Ctrl+V : „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂÜÖ„Éï„Ç°„Ç§„É´ÈÅ∏Êäû
Ctrl+B : ÁèæÂú®„Éá„Ç£„É¨„ÇØ„Éà„É™‰ª•‰∏ã„ÅÆ„Éï„Ç°„Ç§„É´ÈÅ∏Êäû

„Ç≥„Éû„É≥„Éâ: src ‚Üí „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Ç£„É¨„ÇØ„Éà„É™ÈÅ∏ÊäûÔºàZLE„Ç®„É©„ÉºÊôÇÔºâ
„Ç≥„Éû„É≥„Éâ: pd ‚Üí „Ç´„É¨„É≥„Éà„Éá„Ç£„É¨„ÇØ„Éà„É™‰ª•‰∏ã„ÅÆ„Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÔºàZLE„Ç®„É©„ÉºÊôÇÔºâ
================================

EOF
    fi
    
    # Á´ØÊú´Ëµ∑ÂãïÊôÇ„Å´ÂÆüË°å„Åô„ÇãÈñ¢Êï∞„ÇíËøΩÂä†ÔºàÈÅÖÂª∂ÂàùÊúüÂåñÔºâ
    function precmd_setup_keybinds() {
      # „Åì„ÅÆÈñ¢Êï∞„ÅØ„Éó„É≠„É≥„Éó„ÉàË°®Á§∫Ââç„Å´ÊØéÂõûÂÆüË°å„Åï„Çå„Çã
      # ÂøÖË¶Å„Å´Âøú„Åò„Å¶„Ç≠„Éº„Éê„Ç§„É≥„Éâ„ÇíÂÜçË®≠ÂÆöÂèØËÉΩ
      
      # ZLE„Åå„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Åß„ÅÇ„Çå„Å∞„ÄÅVim„É¢„Éº„Éâ„Åß„ÅÆ„Ç≠„Éº„Éê„Ç§„É≥„Éâ„ÇíË©¶Ë°å
      if [[ -o zle ]]; then
        if [ "$IS_WSL" = "1" ]; then
          bindkey -M viins '^]' sk_select_src 2>/dev/null || true
        else
          bindkey -M viins '^]' sk_select_src 2>/dev/null || true
          bindkey -M vicmd '^]' sk_select_src 2>/dev/null || true
        fi
      fi
      
      # ‰∏ÄÂ∫¶ÂÆüË°å„Åó„Åü„Çâ„ÄÅ„Åì„ÅÆÈñ¢Êï∞„Çíprecmd„Éï„ÉÉ„ÇØ„Åã„ÇâÂâäÈô§
      add-zsh-hook -d precmd precmd_setup_keybinds
    }
    
    # „Éó„É≠„É≥„Éó„ÉàË°®Á§∫Ââç„Å´ÂÆüË°å„Åô„Çã„Éï„ÉÉ„ÇØ„ÇíËøΩÂä†
    autoload -Uz add-zsh-hook
    add-zsh-hook precmd precmd_setup_keybinds
  else
    # ZLE„ÅåÁÑ°Âäπ„Å™Â†¥Âêà„ÅØË≠¶Âëä
    [[ -z "$WSL_KEYBINDS_WARNING" ]] && {
      echo "Ë≠¶Âëä: ZLE„ÅåÈùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Åü„ÇÅ„ÄÅ„Ç≠„Éº„Éê„Ç§„É≥„ÉâË®≠ÂÆö„ÅÆ‰ª£„Çè„Çä„Å´„Ç≥„Éû„É≥„Éâ„Ç®„Ç§„É™„Ç¢„Çπ„Çí‰ΩøÁî®„Åó„Åæ„Åô:"
      echo "- src: „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Ç£„É¨„ÇØ„Éà„É™ÈÅ∏Êäû"
      echo "- pd: „Ç´„É¨„É≥„Éà„Éá„Ç£„É¨„ÇØ„Éà„É™‰ª•‰∏ã„ÅÆ„Éï„Ç°„Ç§„É´ÈÅ∏Êäû"
      export WSL_KEYBINDS_WARNING=1
    }
  fi
  
  # ZLE„ÅÆÁä∂ÊÖã„Å´Èñ¢„Çè„Çâ„Åö„ÄÅ„Ç≥„Éû„É≥„Éâ„Å®„Åó„Å¶ÂÆüË°å„Åß„Åç„Çã„Çà„ÅÜ„Å´„Ç®„Ç§„É™„Ç¢„Çπ„ÇíË®≠ÂÆö
  alias src="sk_select_src --direct"
  alias pd="sk_select_file_below_pwd --direct"
  alias project="sk_select_src --direct"
  alias dirfind="sk_change_directory --direct"
else
  # Èùû„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Ç∑„Çß„É´„ÅÆÂ†¥Âêà„ÅØË≠¶Âëä
  [[ -z "$WSL_KEYBINDS_WARNING" ]] && {
    echo "Ë≠¶Âëä: Èùû„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Ç∑„Çß„É´„ÅÆ„Åü„ÇÅ„ÄÅ„Ç≠„Éº„Éê„Ç§„É≥„Éâ„Åå‰ΩøÁî®„Åß„Åç„Åæ„Åõ„Çì„ÄÇ"
    export WSL_KEYBINDS_WARNING=1
  }
fi

# „Ç≠„Éº„Éê„Ç§„É≥„Éâ„Çí„ÉÜ„Çπ„Éà„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
function test_keybindings() {
  echo "„Ç≠„Éº„Éê„Ç§„É≥„Éâ„ÉÜ„Çπ„Éà„É¢„Éº„Éâ„ÇíÈñãÂßã„Åó„Åæ„Åô„ÄÇ„Ç≠„Éº„ÇíÊäº„Åó„Å¶Á¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
  echo "ÁµÇ‰∫Ü„Åô„Çã„Å´„ÅØ Ctrl+D „Çí2ÂõûÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
  cat <<EOF
„ÉÜ„Çπ„Éà„Åô„Çã‰∏ª„Å™„Ç≠„Éº„Éê„Ç§„É≥„Éâ:
- Ctrl+]
- Ctrl+\\
- Ctrl+P
- Alt+]
EOF

  cat -v
}

# Enhanced search functions
function search_in_files() {
  local query="$1"
  if [ -z "$query" ]; then
    echo "Usage: search_in_files <query>"
    return 1
  fi
  rg --color=always --line-number --no-heading --smart-case "$query" | \
    sk --ansi --reverse --height '50%' --preview 'echo {}' \
    --preview-window 'up,60%,border-bottom,+{2}+3/3,~3'
}

function preview_file() {
  local file="$1"
  if [ -z "$file" ]; then
    echo "Usage: preview_file <file>"
    return 1
  fi
  bat --style=numbers --color=always "$file"
}

function search_and_edit() {
  local result=$(search_in_files "$1")
  if [ -n "$result" ]; then
    local file=$(echo "$result" | cut -d':' -f1)
    local line=$(echo "$result" | cut -d':' -f2)
    nvim "+$line" "$file"
  fi
}

# Zen Mode - Toggle sketchybar and borders
ZEN_MODE_ACTIVE=0

function toggle_zen_mode() {
  if [ $ZEN_MODE_ACTIVE -eq 0 ]; then
    # Turn on Zen mode (disable sketchybar and borders)
    brew services stop sketchybar
    brew services stop borders
    ZEN_MODE_ACTIVE=1
    echo "üßò Zen Mode: ON - sketchybar and borders disabled"
  else
    # Turn off Zen mode (enable sketchybar and borders)
    brew services start sketchybar
    brew services start borders
    ZEN_MODE_ACTIVE=0
    echo "üñ•Ô∏è Zen Mode: OFF - sketchybar and borders enabled"
  fi
}

# Create alias for Zen mode
alias zen='toggle_zen_mode'
