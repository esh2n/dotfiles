"use client";

import { Text, Tooltip } from "@sansaninc/one-ui";
import clsx from "clsx";
import type { Route } from "next";
import Link from "next/link";
import { InfoIcon } from "../../../../../../components/ui/icons/Icons";
import { Title } from "../../../../../../components/ui/title/Title";
import { serializeSearchParams } from "../../../enriched-data/search-params";
import type { DataQualityTenantStatistics } from "../types";
import styles from "./Funnel.module.css";
import { HorizontalArrow } from "./HorizontalArrow";

type Props = {
  statistics: DataQualityTenantStatistics;
};

const SOC_ASSIGNED_DESCRIPTION =
  "取り込みデータのうち、Sansanが付与したSOCコードが付与されたデータ";
const UNIQUE_DESCRIPTION = "重複を除いたユニークな企業・事業所のデータ";
const SOC_UNASSIGNED_DESCRIPTION = "SOCコードが付与されなかったデータ";
const DUPLICATES_DESCRIPTION = "同じ企業・事業所の重複データ";

export const Funnel = ({ statistics }: Props) => {
  const totalImported = statistics.totalCount;
  const socAssignedCount = statistics.socV2IdentifiedCount;
  const socUnassignedCount = statistics.socV2UnidentifiedCount;
  const uniqueCompanies = statistics.enterpriseSocV2UniqueCount;
  const uniqueOffices = statistics.establishmentSocV2UniqueCount;
  const duplicatesCount = statistics.duplicateCount;

  const socAssignedPercentage =
    totalImported > 0
      ? ((socAssignedCount / totalImported) * 100).toFixed(1)
      : null;

  const socUnassignedPercentage =
    totalImported > 0
      ? ((socUnassignedCount / totalImported) * 100).toFixed(1)
      : null;

  const duplicatesPercentage =
    socAssignedCount > 0
      ? ((duplicatesCount / socAssignedCount) * 100).toFixed(1)
      : null;

  const totalImportedPercentage = totalImported > 0 ? "100.0" : null;

  return (
    <div className={styles.wrapper}>
      <div className={styles.container}>
        {/* 段階1: 取り込みデータ */}
        <div className={styles.stage}>
          <div className={styles.mainBox}>
            <div className={styles.funnelBox}>
              <div className={styles.funnel1}>
                <div className={styles.funnelContent}>
                  <Title size="large" className={styles.funnelLabel}>
                    取り込みデータ
                  </Title>
                  <Tooltip
                    trigger={<InfoIcon className={styles.infoIconWhite} />}
                    content={<Text>全ての取り込みデータの総数</Text>}
                    placement="top"
                  />
                </div>
              </div>
            </div>
            <div className={styles.centerBox}>
              {totalImportedPercentage !== null && (
                <Title size="large" className={styles.percentage}>
                  {totalImportedPercentage}%
                </Title>
              )}
              <Link
                href={
                  `/enriched-data${serializeSearchParams({
                    page: 1,
                    filter: {},
                  })}` as Route
                }
                className={styles.countLink}
              >
                <Title size="large" className={styles.countPrimary}>
                  {totalImported.toLocaleString()}件
                </Title>
              </Link>
            </div>
          </div>
          <div className={styles.stageRight} />
        </div>

        {/* 段階2: SOC付与済み */}
        <div className={styles.stage}>
          <div className={styles.mainBox}>
            <div className={styles.funnelBox}>
              <div className={styles.funnel2}>
                <div className={styles.funnelContent}>
                  <Title size="large" className={styles.funnelLabel}>
                    SOC付与済み
                  </Title>
                  <Tooltip
                    trigger={<InfoIcon className={styles.infoIconWhite} />}
                    content={<Text>{SOC_ASSIGNED_DESCRIPTION}</Text>}
                    placement="top"
                  />
                </div>
              </div>
            </div>
            <div className={styles.centerBox}>
              {socAssignedPercentage !== null && (
                <Title size="large" className={styles.percentage}>
                  {socAssignedPercentage}%
                </Title>
              )}
              <Link
                href={
                  `/enriched-data${serializeSearchParams({
                    page: 1,
                    filter: {
                      identificationResult: "IDENTIFIED",
                    },
                  })}` as Route
                }
                className={styles.countLink}
              >
                <Title size="large" className={styles.countPrimary}>
                  {socAssignedCount.toLocaleString()}件
                </Title>
              </Link>
            </div>
          </div>
          <div className={styles.horizontalArrow}>
            <HorizontalArrow />
          </div>
          <div className={styles.stageRight}>
            <div className={styles.rightBox}>
              <div className={styles.rightBoxContent}>
                <div className={styles.labelWithIcon}>
                  <Title size="medium">SOC未付与</Title>
                  <Tooltip
                    trigger={<InfoIcon className={styles.infoIcon} />}
                    content={<Text>{SOC_UNASSIGNED_DESCRIPTION}</Text>}
                    placement="top"
                  />
                </div>
                <div className={styles.rightBoxValues}>
                  {socUnassignedPercentage !== null && (
                    <Title size="large" className={styles.percentage}>
                      {socUnassignedPercentage}%
                    </Title>
                  )}
                  <Title size="large">
                    {socUnassignedCount.toLocaleString()}件
                  </Title>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* 段階3: ユニーク企業・事業所 */}
        <div className={styles.stage}>
          <div className={styles.mainBox}>
            <div className={styles.funnelBox}>
              <div className={styles.funnel3}>
                <div className={styles.funnelContent}>
                  <Title size="large" className={styles.funnelLabel}>
                    ユニーク企業・事業所
                  </Title>
                  <Tooltip
                    trigger={<InfoIcon className={styles.infoIconWhite} />}
                    content={<Text>{UNIQUE_DESCRIPTION}</Text>}
                    placement="top"
                  />
                </div>
              </div>
            </div>
            <div className={clsx(styles.centerBox, styles.centerBoxColumn)}>
              <div className={styles.uniqueRow}>
                <span className={styles.uniqueLabel}>ユニーク企業</span>
                <Title size="large">{uniqueCompanies.toLocaleString()}件</Title>
              </div>
              <div className={styles.uniqueRow}>
                <span className={styles.uniqueLabel}>ユニーク事業所</span>
                <Title size="large">{uniqueOffices.toLocaleString()}件</Title>
              </div>
            </div>
          </div>
          <div className={styles.horizontalArrow}>
            <HorizontalArrow />
          </div>
          <div className={styles.stageRight}>
            <div className={styles.rightBox}>
              <div className={styles.rightBoxContent}>
                <div className={styles.labelWithIcon}>
                  <Title size="medium">重複</Title>
                  <Tooltip
                    trigger={<InfoIcon className={styles.infoIcon} />}
                    content={<Text>{DUPLICATES_DESCRIPTION}</Text>}
                    placement="top"
                  />
                </div>
                <div className={styles.rightBoxValues}>
                  {duplicatesPercentage !== null && (
                    <Title size="large" className={styles.percentage}>
                      {duplicatesPercentage}%
                    </Title>
                  )}
                  <Title size="large">
                    {duplicatesCount.toLocaleString()}件
                  </Title>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};
