package statistics_computation_initiation

import (
	"context"

	app_proto "github.com/sansaninc/sdi-contracts/integrated_data/enriched_data/statistics_computation_initiation/v1"
	"github.com/sansaninc/sdi-core/integrated_data/enriched_data/internal/statistics_computation_initiation/internal/core"
	"github.com/sansaninc/sdi-core/shared/golang_lib/ex"
	"github.com/sansaninc/sdi-core/shared/golang_lib/pubsubx"
	"github.com/sansaninc/sdi-core/shared/golang_lib/sqlxx"
	"github.com/sansaninc/sdi-core/shared/golang_lib/stdx"
)

type addApplicationServiceV1 struct {
	connection sqlxx.Connection
	repos      *core.Repository
	publisher  pubsubx.Publisher
	clock      stdx.Clock
}

type addV1Args struct {
	msg *app_proto.StatisticsComputationInitiationServiceAddRequest
}

type addV1Result struct {
	rootEntity *core.RootEntity
}

func (r *addV1Result) toResponse() *app_proto.StatisticsComputationInitiationServiceAddResponse {
	return r.rootEntity.ToAddResponseV1()
}

// TODO: Application Serviceのロジックを実装してください。
// TODO: Implement the logic for the Application Service.
// サービスロジック以外の処理 (値の変換、DB からのデータ取得等) は internal/core パッケージに実装してください。
// エラーは下記ドキュメントを参考に ex.WrapAsFoo を使用して適切にラップしてください。
// https://github.com/sansaninc/sdi-core/blob/main/docs/adr/application/APP_009_api_error.md
func (s *addApplicationServiceV1) execute(ctx context.Context, req *addV1Args) (*addV1Result, error) {
	// TODO: req から必要な情報を取得して新しい RootEntity を作成する
	// TODO: Extract necessary information from req and create a new RootEntity
	_ = req
	newRootEntity := core.NewRootEntity(core.NewCreatedAt(s.clock.Now()))

	tx, err := s.connection.Begin(ctx)
	if err != nil {
		return nil, ex.Wrap(err)
	}
	defer tx.Rollback(ctx)

	if err := s.repos.Insert(ctx, tx, newRootEntity); err != nil {
		return nil, ex.Wrap(err)
	}

	event := newRootEntity.ToAddedEvent()
	if err := s.publisher.Publish(ctx, tx, event); err != nil {
		return nil, ex.Wrap(err)
	}

	if err := tx.Commit(ctx); err != nil {
		return nil, ex.Wrap(err)
	}

	return &addV1Result{
		rootEntity: newRootEntity,
	}, nil
}
