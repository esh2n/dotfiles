import { describe, expect, it } from "vitest";
import { calculateFunnelPercentages } from "./calculations";

describe("calculateFunnelPercentages", () => {
  it("正常系：全ての値が正しく計算される", () => {
    const result = calculateFunnelPercentages(1000, 800, 200, 50);

    expect(result.socAssignedPercentage).toBe("80.0");
    expect(result.socUnassignedPercentage).toBe("20.0");
    expect(result.duplicatesPercentage).toBe("6.3");
    expect(result.totalImportedPercentage).toBe("100.0");
  });

  it("totalImported が 0 の場合、割合は null になる", () => {
    const result = calculateFunnelPercentages(0, 0, 0, 0);

    expect(result.socAssignedPercentage).toBeNull();
    expect(result.socUnassignedPercentage).toBeNull();
    expect(result.duplicatesPercentage).toBeNull();
    expect(result.totalImportedPercentage).toBeNull();
  });

  it("socAssignedCount が 0 の場合、duplicatesPercentage は null になる", () => {
    const result = calculateFunnelPercentages(1000, 0, 1000, 0);

    expect(result.socAssignedPercentage).toBe("0.0");
    expect(result.socUnassignedPercentage).toBe("100.0");
    expect(result.duplicatesPercentage).toBeNull();
    expect(result.totalImportedPercentage).toBe("100.0");
  });

  it("小数点第1位まで表示される", () => {
    const result = calculateFunnelPercentages(100, 33, 67, 10);

    expect(result.socAssignedPercentage).toBe("33.0");
    expect(result.socUnassignedPercentage).toBe("67.0");
    expect(result.duplicatesPercentage).toBe("30.3");
  });

  it("パーセンテージの合計が100%になる（socAssigned + socUnassigned）", () => {
    const result = calculateFunnelPercentages(1000, 600, 400, 50);

    const socAssignedNum = Number.parseFloat(result.socAssignedPercentage!);
    const socUnassignedNum = Number.parseFloat(result.socUnassignedPercentage!);

    expect(socAssignedNum + socUnassignedNum).toBe(100.0);
  });
});
