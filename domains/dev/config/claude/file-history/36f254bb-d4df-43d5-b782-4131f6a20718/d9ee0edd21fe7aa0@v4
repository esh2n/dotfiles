package core

import (
	"context"
	"errors"
	"fmt"

	"github.com/sansaninc/sdi-core/shared/golang_lib/ex"
	"github.com/sansaninc/sdi-core/shared/golang_lib/sqlxx"
)

// TODO: Root Entity の永続化および復元に関する処理のみを記述してください。
// TODO: Describe only the persistence and restoration processes for the Root Entity.
// Please refer to the following document for more information.
// https://github.com/sansaninc/sdi-core/blob/main/docs/adr/application/APP_024_repository.md

type Repository struct {
}

func NewRepository() *Repository {
	return &Repository{}
}

const rootTableQuery = `
SELECT
  id,
  created_at
FROM
  enriched_data_statistics_computation_initiation
`

var ErrNotFound = errors.New("not found")

func (r *Repository) GetByID(ctx context.Context, accessor sqlxx.Accessor, id ID) (*RootEntity, error) {
	// TODO: query を調整する
	// TODO: Adjust the query
	query := fmt.Sprintf(`-- name: statistics_computation_initiation.GetByID
%s
WHERE id = @id
`, rootTableQuery)

	root, err := sqlxx.TypedAccessor[EnrichedDataStatisticsComputationInitiation](accessor).SelectSingle(
		ctx, query, nil,
		// sqlxx.WithSkipAuthenticatedTenantIDCheckSelectOption(),
	)
	if err != nil {
		if errors.Is(err, sqlxx.ErrNoRowsFound) {
			return nil, ex.Wrap(ErrNotFound)
		}
		return nil, ex.Wrap(err)
	}

	return r.restore(root), nil
}

func (r *Repository) restore(root *EnrichedDataStatisticsComputationInitiation) *RootEntity {
	// TODO: DB に保存された値からルートエンティティを復元する処理を実装してください。保存された値は正しいはずなので、この関数は error を返さずに panic します（must* 系の関数で VO を復元すること）。
	// TODO: Implement the process of restoring the root entity from the values saved in the DB. Since the saved values should be correct, this function will panic without returning an error (restore VOs using must* functions).
	return &RootEntity{
		id:        mustParseID(root.ID),
		createdAt: NewCreatedAt(root.CreatedAt),
	}
}

func (r *Repository) Insert(ctx context.Context, tx sqlxx.Transaction, rootEntity *RootEntity) error {
	row := &EnrichedDataStatisticsComputationInitiation{
		ID:        rootEntity.id.value.String(),
		CreatedAt: rootEntity.createdAt.value,
	}
	_, err := row.Insert(ctx, tx)
	if err != nil {
		return ex.Wrap(err)
	}

	return nil
}
