package core

import (
	"context"

	"github.com/sansaninc/sdi-core/integrated_data/shared/bc_db"
	"github.com/sansaninc/sdi-core/shared/golang_lib/contextx"
	"github.com/sansaninc/sdi-core/shared/golang_lib/ex"
	"github.com/sansaninc/sdi-core/shared/golang_lib/sqlxx"
)

type Repository struct {
}

func NewRepository() *Repository {
	return &Repository{}
}

func (r *Repository) Insert(ctx context.Context, tx sqlxx.Transaction, rootEntity *RootEntity) error {
	tenantID, err := contextx.GetTenantID(ctx)
	if err != nil {
		return ex.Wrap(err)
	}

	row := &bc_db.EnrichedDataStatisticsComputationInitiation{
		ID:             rootEntity.id.value.String(),
		TenantID:       tenantID.String(),
		CreatedAt:      rootEntity.createdAt.value,
		RetentionUntil: rootEntity.retentionUntil.value,
	}
	if _, err := row.Insert(ctx, tx); err != nil {
		return ex.Wrap(err)
	}

	return nil
}
