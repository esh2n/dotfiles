package statistics_computation_initiation

import (
	"context"
	"time"

	"github.com/sansaninc/sdi-core/shared/golang_lib/common_vo"
	"github.com/sansaninc/sdi-core/shared/golang_lib/ex"
	"github.com/sansaninc/sdi-core/shared/golang_lib/sqlxx"
)

type listTenantLatestInitiationQueryServiceV1 struct {
	connection sqlxx.Connection
}

type listTenantLatestInitiationV1Args struct {
	tenantIDs []common_vo.TenantID
}

type listTenantLatestInitiationQueryServiceV1Result struct {
	Items map[common_vo.TenantID]*time.Time
}

func (s *listTenantLatestInitiationQueryServiceV1) query(ctx context.Context, args *listTenantLatestInitiationV1Args) (*listTenantLatestInitiationQueryServiceV1Result, error) {
	if len(args.tenantIDs) == 0 {
		return &listTenantLatestInitiationQueryServiceV1Result{
			Items: make(map[common_vo.TenantID]*time.Time),
		}, nil
	}

	tenantIDStrs := make([]string, len(args.tenantIDs))
	for i, tenantID := range args.tenantIDs {
		tenantIDStrs[i] = tenantID.String()
	}

	const query = `-- statistics_computation_initiation.listTenantLatestInitiation
SELECT
  tenant_id,
  MAX(created_at) as created_at
FROM
  enriched_data_statistics_computation_initiation
WHERE
  tenant_id IN UNNEST(@tenant_ids)
GROUP BY
  tenant_id
`

	rows, err := sqlxx.TypedAccessor[struct {
		TenantID  string     `db:"tenant_id"`
		CreatedAt *time.Time `db:"created_at"`
	}](s.connection).SelectList(
		ctx,
		query,
		struct {
			TenantIDs []string `db:"tenant_ids"`
		}{
			TenantIDs: tenantIDStrs,
		},
		sqlxx.WithSkipAuthenticatedTenantIDCheckSelectOption(),
	)
	if err != nil {
		return nil, ex.Wrap(err)
	}

	result := make(map[common_vo.TenantID]*time.Time, len(rows))
	for _, row := range rows {
		tenantID, err := common_vo.NewTenantID(row.TenantID)
		if err != nil {
			return nil, ex.Wrap(err)
		}
		result[tenantID] = row.CreatedAt
	}

	return &listTenantLatestInitiationQueryServiceV1Result{
		Items: result,
	}, nil
}
