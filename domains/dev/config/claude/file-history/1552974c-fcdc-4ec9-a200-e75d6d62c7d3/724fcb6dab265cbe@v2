import { timestampDate } from "@bufbuild/protobuf/wkt";
import type { StatisticsServiceGetForSdiAppResponse_IntegratedSystemStatistics } from "@sansaninc/sdi-contracts/integrated_data/enriched_data/statistics/v1/get_for_sdi_app_message_pb";
import { StatisticsService } from "@sansaninc/sdi-contracts/integrated_data/enriched_data/statistics/v1/service_pb";
import type { IntegratedSystem as IntegratedSystemProto } from "@sansaninc/sdi-contracts/tenant/tenant_configuration/integrated_system/v1/model_pb";
import { IntegratedSystemService } from "@sansaninc/sdi-contracts/tenant/tenant_configuration/integrated_system/v1/service_pb";
import { createConnectClient } from "../../../../lib/connect/client";
import {
  cookieHeaders,
  serverTransport,
} from "../../../../lib/connect/server-transport";
import {
  type DataQualityStatistics,
  type DataSummaryStatistics,
  toDataQualityIntegratedSystemStatistics,
  toDataQualityTenantStatistics,
} from "./_components/types";

// 1stリリースでは固定値。今後はtarget_list_statistics APIから取得する予定
const CORPORATION_TOTAL_COUNT = 5016410;
const ESTABLISHMENT_TOTAL_COUNT = 6117457;

const statisticsClient = createConnectClient(
  StatisticsService,
  serverTransport,
);

const integratedSystemClient = createConnectClient(
  IntegratedSystemService,
  serverTransport,
);

type FetchStatisticsForHomeResult = {
  summaryStatistics: DataSummaryStatistics[];
  dataQualityStatistics: DataQualityStatistics;
};

export const fetchStatisticsForHome =
  async (): Promise<FetchStatisticsForHomeResult> => {
    const headers = await cookieHeaders();
    const [statisticsResponse, integratedSystemsResponse] = await Promise.all([
      statisticsClient.getForSdiApp({}, { headers }),
      integratedSystemClient.list({}, { headers }),
    ]);

    const integratedSystemMap = new Map<string, IntegratedSystemProto>(
      integratedSystemsResponse.integratedSystems.map(
        (system: IntegratedSystemProto) => [system.id, system],
      ),
    );

    const tenantStatistics = toDataQualityTenantStatistics(
      statisticsResponse.tenantStatistics,
    );

    const integratedSystemStatistics = (
      statisticsResponse.systemStatistics || []
    ).map(
      (
        systemStat: StatisticsServiceGetForSdiAppResponse_IntegratedSystemStatistics,
      ) =>
        toDataQualityIntegratedSystemStatistics(
          systemStat,
          integratedSystemMap,
        ),
    );

    const calculatedAt = statisticsResponse.calculatedAt
      ? timestampDate(statisticsResponse.calculatedAt)
      : undefined;

    const dataQualityStatistics: DataQualityStatistics = {
      tenantStatistics,
      integratedSystemStatistics,
      calculatedAt,
    };

    const calculatedAtISOString = calculatedAt
      ? calculatedAt.toISOString()
      : new Date().toISOString();

    const summaryStatistics: DataSummaryStatistics[] = [
      {
        entityType: "corporation",
        totalCount: CORPORATION_TOTAL_COUNT,
        importedDataCount: tenantStatistics.enterpriseSocV2UniqueCount,
        whitespaceCount:
          CORPORATION_TOTAL_COUNT - tenantStatistics.enterpriseSocV2UniqueCount,
        updatedAt: calculatedAtISOString,
      },
      {
        entityType: "establishment",
        totalCount: ESTABLISHMENT_TOTAL_COUNT,
        importedDataCount: tenantStatistics.establishmentSocV2UniqueCount,
        whitespaceCount:
          ESTABLISHMENT_TOTAL_COUNT -
          tenantStatistics.establishmentSocV2UniqueCount,
        updatedAt: calculatedAtISOString,
      },
    ];

    return {
      summaryStatistics,
      dataQualityStatistics,
    };
  };
