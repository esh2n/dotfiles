#!/usr/bin/env bash

# -----------------------------------------------------------------------------
# Dev Domain Installer
# 開発ドメインインストーラー
# -----------------------------------------------------------------------------
# All development tools: Terminal, Shell, Editor, Languages, DB, AI
# 全開発ツール: ターミナル, シェル, エディタ, 言語, DB, AI
# -----------------------------------------------------------------------------

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_ROOT="$(cd "${SCRIPT_DIR}/../.." && pwd)"
source "${DOTFILES_ROOT}/core/utils/common.sh"

# -----------------------------------------------------------------------------
# 1. System Tools (Brewfile)
# システムツール (Brewfile)
# -----------------------------------------------------------------------------

log_info "Installing Dev Domain tools..."

if has_command "brew"; then
    install_brewfile "${SCRIPT_DIR}/packages/Brewfile"
else
    log_error "Homebrew not found. Skipping Brewfile."
fi

# -----------------------------------------------------------------------------
# 2. Language Runtimes & Tools (mise)
# 言語ランタイムとツール (mise)
# -----------------------------------------------------------------------------

if has_command "mise"; then
    log_info "Installing language runtimes via mise..."
    
    # Activate mise to make runtimes available in PATH
    # miseをアクティベートしてランタイムをPATHに追加
    eval "$(mise activate bash)" 2>/dev/null || true
    
    # Install runtimes defined in mise config
    # mise設定で定義されたランタイムをインストール
    # Use config file from dev domain (will be symlinked in phase_config)
    # devドメインの設定ファイルを使用（phase_configでsymlinkされる）
    if [[ -f "${HOME}/.config/mise/config.toml" ]]; then
        mise install
    elif [[ -f "${SCRIPT_DIR}/config/mise/config.toml" ]]; then
        # If symlink not created yet, use source file directly
        # symlinkがまだ作成されていない場合、ソースファイルを直接使用
        log_info "Using mise config from source: ${SCRIPT_DIR}/config/mise/config.toml"
        MISE_CONFIG_DIR="${SCRIPT_DIR}/config/mise" mise install
    else
        log_warn "mise config.toml not found. Skipping runtime installation."
    fi
    
    # Ensure mise runtimes are in PATH for subsequent commands
    # 後続のコマンドでmiseランタイムがPATHに含まれるようにする
    eval "$(mise activate bash)" 2>/dev/null || true
else
    log_warn "mise not found. Skipping runtime setup."
fi

# -----------------------------------------------------------------------------
# 3. Package Manager Installations
# パッケージマネージャーインストール
# -----------------------------------------------------------------------------

# Cargo packages (Rust) - requires rust runtime from mise
# Cargoパッケージ（Rust）- miseのrustランタイムが必要

# Ensure cargo is in PATH by checking mise shims directory
# miseのshimsディレクトリを確認してcargoがPATHに含まれていることを保証
if ! has_command "cargo" && has_command "mise"; then
    export PATH="${HOME}/.local/share/mise/shims:${PATH}"
    eval "$(mise activate bash)" 2>/dev/null || true
fi

if has_command "cargo" && [[ -f "${SCRIPT_DIR}/packages/cargo.txt" ]]; then
    log_info "Installing Cargo packages..."
    while IFS= read -r line || [[ -n "$line" ]]; do
        [[ $line =~ ^#.*$ ]] && continue
        [[ -z $line ]] && continue

        # Remove comments and trim whitespace
        # コメントを削除し、空白をトリム
        package_name=$(echo "$line" | sed 's/\s*#.*$//' | xargs)
        log_info "Installing: $package_name"

        if [[ $package_name == "pacifica" ]]; then
            cargo install --git https://github.com/serinuntius/pacifica.git || log_warn "Failed to install: $package_name"
        else
            cargo install "$package_name" || log_warn "Failed to install: $package_name"
        fi
    done < "${SCRIPT_DIR}/packages/cargo.txt"
else
    if ! has_command "cargo"; then
        log_warn "cargo not found. Skipping Cargo package installation."
        log_warn "You may need to run 'mise install' first to install Rust."
    fi
fi

# Go packages - requires go runtime from mise
# Goパッケージ - miseのgoランタイムが必要
if has_command "go" && [[ -f "${SCRIPT_DIR}/packages/go.txt" ]]; then
    log_info "Installing Go packages..."
    export GOPATH="${HOME}/go"
    export GOBIN="${GOPATH}/bin"
    mkdir -p "$GOBIN"
    
    while IFS= read -r line || [[ -n "$line" ]]; do
        [[ $line =~ ^#.*$ ]] && continue
        [[ -z $line ]] && continue
        
        # Remove comments and trim whitespace
        # コメントを削除し、空白をトリム
        package_name=$(echo "$line" | sed 's/\s*#.*$//' | xargs)
        log_info "Installing: ${package_name}@latest"
        go install "${package_name}@latest" || log_warn "Failed to install: ${package_name}@latest"
    done < "${SCRIPT_DIR}/packages/go.txt"
fi

# Bun packages - requires bun runtime from mise
# Bunパッケージ - miseのbunランタイムが必要
if has_command "bun" && [[ -f "${SCRIPT_DIR}/packages/bun.txt" ]]; then
    log_info "Installing Bun packages..."
    while IFS= read -r line || [[ -n "$line" ]]; do
        [[ $line =~ ^#.*$ ]] && continue
        [[ -z $line ]] && continue
        
        # Remove comments and trim whitespace
        # コメントを削除し、空白をトリム
        package_name=$(echo "$line" | sed 's/\s*#.*$//' | xargs)
        log_info "Installing: $package_name"
        bun install -g "$package_name" || log_warn "Failed to install: $package_name"
    done < "${SCRIPT_DIR}/packages/bun.txt"
fi

# Gem packages (Ruby) - requires ruby runtime from mise
# Gemパッケージ（Ruby）- miseのrubyランタイムが必要
if has_command "gem" && [[ -f "${SCRIPT_DIR}/packages/gem.txt" ]]; then
    log_info "Installing Ruby gems..."
    while IFS= read -r line || [[ -n "$line" ]]; do
        [[ $line =~ ^#.*$ ]] && continue
        [[ -z $line ]] && continue
        
        # Remove comments and trim whitespace
        # コメントを削除し、空白をトリム
        package_name=$(echo "$line" | sed 's/\s*#.*$//' | xargs)
        log_info "Installing: $package_name"
        gem install "$package_name" || log_warn "Failed to install: $package_name"
    done < "${SCRIPT_DIR}/packages/gem.txt"
fi

# -----------------------------------------------------------------------------
# 4. Neovim Setup
# Neovimセットアップ
# -----------------------------------------------------------------------------

# Ensure nvim-switcher is executable
if [[ -f "${SCRIPT_DIR}/bin/nvim-switch" ]]; then
    chmod +x "${SCRIPT_DIR}/bin/nvim-switch"
fi

# Install Neovim distributions if needed
# NvChad
if [[ ! -d "${HOME}/.config/nvim-nvchad" ]]; then
    log_info "Cloning NvChad..."
    git clone https://github.com/NvChad/NvChad ~/.config/nvim-nvchad --depth 1
fi

# LazyVim
if [[ ! -d "${HOME}/.config/nvim-lazyvim" ]]; then
    log_info "Cloning LazyVim..."
    git clone https://github.com/LazyVim/starter ~/.config/nvim-lazyvim
fi

# AstroVim
if [[ ! -d "${HOME}/.config/nvim-astrovim" ]]; then
    log_info "Cloning AstroVim..."
    git clone --depth 1 https://github.com/AstroNvim/AstroNvim ~/.config/nvim-astrovim
fi

# -----------------------------------------------------------------------------
# 5. Additional Setup
# 追加セットアップ
# -----------------------------------------------------------------------------

# Setup git-lfs
if has_command "git-lfs"; then
    log_info "Initializing git-lfs..."
    git lfs install
fi

log_success "Dev Domain installed."
