#!/usr/bin/env bash

# -----------------------------------------------------------------------------
# Theme Switcher
# ãƒ†ãƒ¼ãƒžåˆ‡ã‚Šæ›¿ãˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# -----------------------------------------------------------------------------

set -e

# Paths
if [[ -n "$DOTFILES_ROOT" ]]; then
    CONFIG_DIR="$DOTFILES_ROOT/domains/system/config"
else
    # Fallback
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    CONFIG_DIR="$(dirname "$(dirname "$SCRIPT_DIR")")/config"
fi

THEMES_DIR="$CONFIG_DIR/themes"
TARGET_LINK="$CONFIG_DIR/colors.lua"

# Helper: Show usage
usage() {
    echo "Usage: $(basename "$0") [theme]"
    echo ""
    echo "Available themes:"
    if [[ -d "$THEMES_DIR" ]]; then
        for theme in "$THEMES_DIR"/*.lua; do
            echo "  - $(basename "$theme" .lua)"
        done
    fi
    echo ""
    echo "Example:"
    echo "  theme-switch nord"
}

# Main
THEME="$1"

if [[ -z "$THEME" ]]; then
    usage
    exit 1
fi

THEME_FILE="$THEMES_DIR/$THEME.lua"

if [[ ! -f "$THEME_FILE" ]]; then
    echo "Error: Theme '$THEME' not found."
    usage
    exit 1
fi

echo "Switching theme to: $THEME"

# Update symlink (System Colors)
ln -sf "$THEME_FILE" "$TARGET_LINK"
echo "âœ… Updated system config symlink"

# Update Ghostty Theme
GHOSTTY_CONFIG_DIR="$DOTFILES_ROOT/domains/dev/config/ghostty"
if [[ ! -d "$GHOSTTY_CONFIG_DIR" ]]; then
    # Fallback
    GHOSTTY_CONFIG_DIR="$HOME/dotfiles/domains/dev/config/ghostty"
fi

if [[ -d "$GHOSTTY_CONFIG_DIR" ]]; then
    GHOSTTY_THEME="$GHOSTTY_CONFIG_DIR/themes/$THEME"
    if [[ -f "$GHOSTTY_THEME" ]]; then
        ln -sf "$GHOSTTY_THEME" "$GHOSTTY_CONFIG_DIR/theme"
        echo "âœ… Updated Ghostty theme symlink"
        # Ghostty auto-reloads on config change
    else
        echo "âš ï¸  Ghostty theme '$THEME' not found"
    fi
fi

# Update Borders Theme
BORDERS_CONFIG_DIR="$DOTFILES_ROOT/domains/workspace/config/borders"
if [[ ! -d "$BORDERS_CONFIG_DIR" ]]; then
    # Fallback
    BORDERS_CONFIG_DIR="$HOME/dotfiles/domains/workspace/config/borders"
fi

if [[ -d "$BORDERS_CONFIG_DIR" ]]; then
    BORDERS_THEME="$BORDERS_CONFIG_DIR/themes/$THEME.sh"
    if [[ -f "$BORDERS_THEME" ]]; then
        ln -sf "$BORDERS_THEME" "$BORDERS_CONFIG_DIR/colors.sh"
        echo "âœ… Updated Borders theme symlink"
        
        # Reload Borders
        if command -v borders >/dev/null 2>&1; then
            echo "ðŸ”„ Reloading Borders..."
            # Re-run bordersrc to apply new colors
            "$BORDERS_CONFIG_DIR/bordersrc"
        fi
    else
        echo "âš ï¸  Borders theme '$THEME' not found"
    fi
fi

# Update Zellij Theme
ZELLIJ_CONFIG_DIR="$HOME/.config/zellij"
if [[ -d "$ZELLIJ_CONFIG_DIR" ]]; then
    ZELLIJ_LAYOUT="$ZELLIJ_CONFIG_DIR/layouts/$THEME.kdl"
    if [[ -f "$ZELLIJ_LAYOUT" ]]; then
        # Update config to use the theme layout
        if [[ -f "$ZELLIJ_CONFIG_DIR/config.kdl" ]]; then
            if [[ -w "$ZELLIJ_CONFIG_DIR/config.kdl" ]]; then
                sed -i '' "s/default_layout \"[^\"]*\"/default_layout \"$THEME\"/" "$ZELLIJ_CONFIG_DIR/config.kdl"
                echo "âœ… Updated Zellij theme layout"
            else
                chmod 666 "$ZELLIJ_CONFIG_DIR/config.kdl"
                sed -i '' "s/default_layout \"[^\"]*\"/default_layout \"$THEME\"/" "$ZELLIJ_CONFIG_DIR/config.kdl"
                chmod 444 "$ZELLIJ_CONFIG_DIR/config.kdl"
                echo "âœ… Updated Zellij theme layout"
            fi
        fi
    else
        echo "âš ï¸  Zellij layout '$THEME' not found"
    fi
fi

# Update and Reload Sketchybar
SKETCHYBAR_CONFIG_DIR="$DOTFILES_ROOT/domains/workspace/config/sketchybar"
if [[ ! -d "$SKETCHYBAR_CONFIG_DIR" ]]; then
    # Fallback
    SKETCHYBAR_CONFIG_DIR="$HOME/dotfiles/domains/workspace/config/sketchybar"
fi

if [[ -d "$SKETCHYBAR_CONFIG_DIR" ]] && command -v sketchybar >/dev/null 2>&1; then
    echo "ðŸ”„ Updating and reloading Sketchybar..."

    # Touch configuration files to trigger theme reload
    touch "$SKETCHYBAR_CONFIG_DIR/colors.lua"
    touch "$SKETCHYBAR_CONFIG_DIR/bar.lua" 2>/dev/null || true
    touch "$SKETCHYBAR_CONFIG_DIR/init.lua" 2>/dev/null || true

    # Force sketchybar to exit and restart (more reliable than --reload)
    pkill -f sketchybar 2>/dev/null || true
    sleep 0.5

    # Start sketchybar again (it should auto-start, but let's be explicit)
    nohup sketchybar > /dev/null 2>&1 &
    echo "âœ… Restarted Sketchybar with new theme"
fi

# Reload WezTerm (usually automatic, but we can touch config to force)
# We assume wezterm config is at ~/.config/wezterm/wezterm.lua
WEZTERM_CONFIG="$HOME/.config/wezterm/wezterm.lua"
if [[ -f "$WEZTERM_CONFIG" ]]; then
    echo "ðŸ”„ Reloading WezTerm..."
    touch "$WEZTERM_CONFIG"
fi

echo "âœ¨ Theme switched successfully!"
