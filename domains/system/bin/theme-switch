#!/usr/bin/env bash

# -----------------------------------------------------------------------------
# Theme Switcher
# テーマ切り替えスクリプト
# -----------------------------------------------------------------------------

set -e

# Load utilities
if [[ -n "$DOTFILES_ROOT" ]]; then
    source "$DOTFILES_ROOT/core/utils/common.sh"
elif [[ -f "$HOME/dotfiles/core/utils/common.sh" ]]; then
    source "$HOME/dotfiles/core/utils/common.sh"
fi

# VSCode/Cursor theme mapping (POSIX compatible)
get_vscode_theme() {
    case "$1" in
        catppuccin) echo "Catppuccin Mocha" ;;
        dracula) echo "Dracula" ;;
        everforest) echo "Everforest Dark" ;;
        gruvbox) echo "Gruvbox Dark Medium" ;;
        kanagawa) echo "Kanagawa Wave" ;;
        nord) echo "Nord" ;;
        onedark) echo "Atom One Dark" ;;
        rosepine) echo "Rosé Pine" ;;
        solarized) echo "Solarized Dark" ;;
        tokyonight) echo "Tokyo Night" ;;
        *) echo "" ;;
    esac
}

# NvChad theme mapping
get_nvchad_theme() {
    case "$1" in
        catppuccin) echo "catppuccin" ;;
        dracula) echo "chadracula" ;;
        everforest) echo "everforest" ;;
        gruvbox) echo "gruvbox" ;;
        kanagawa) echo "kanagawa" ;;
        nord) echo "nord" ;;
        onedark) echo "onedark" ;;
        rosepine) echo "rosepine" ;;
        solarized) echo "solarized_dark" ;;
        tokyonight) echo "tokyonight" ;;
        *) echo "catppuccin" ;;
    esac
}

# Paths
if [[ -n "$DOTFILES_ROOT" ]]; then
    CONFIG_DIR="$DOTFILES_ROOT/domains/system/config"
else
    # Fallback
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    CONFIG_DIR="$(dirname "$(dirname "$SCRIPT_DIR")")/config"
fi

THEMES_DIR="$CONFIG_DIR/themes"
TARGET_LINK="$CONFIG_DIR/colors.lua"

# Helper: Show usage
usage() {
    echo "Usage: $(basename "$0") [theme]"
    echo ""
    echo "Available themes:"
    if [[ -d "$THEMES_DIR" ]]; then
        for theme in "$THEMES_DIR"/*.lua; do
            echo "  - $(basename "$theme" .lua)"
        done
    fi
    echo ""
    echo "Example:"
    echo "  theme-switch nord"
}

# Main
THEME="$1"

if [[ -z "$THEME" ]]; then
    usage
    exit 1
fi

THEME_FILE="$THEMES_DIR/$THEME.lua"

if [[ ! -f "$THEME_FILE" ]]; then
    log_error "Theme '$THEME' not found."
    usage
    exit 1
fi

log_info "Switching theme to: $THEME"

# Update symlink (System Colors)
ln -sf "$THEME_FILE" "$TARGET_LINK"
log_success "Updated system config symlink"

# Update Ghostty Theme
GHOSTTY_CONFIG_DIR="$DOTFILES_ROOT/domains/dev/config/ghostty"
if [[ ! -d "$GHOSTTY_CONFIG_DIR" ]]; then
    # Fallback
    GHOSTTY_CONFIG_DIR="$HOME/dotfiles/domains/dev/config/ghostty"
fi

if [[ -d "$GHOSTTY_CONFIG_DIR" ]]; then
    GHOSTTY_THEME="$GHOSTTY_CONFIG_DIR/themes/$THEME"
    if [[ -f "$GHOSTTY_THEME" ]]; then
        ln -sf "$GHOSTTY_THEME" "$GHOSTTY_CONFIG_DIR/theme"
        log_success "Updated Ghostty theme symlink"
        # Ghostty auto-reloads on config change
    else
        log_warn "Ghostty theme '$THEME' not found"
    fi
fi

# Update Borders Theme
BORDERS_CONFIG_DIR="$DOTFILES_ROOT/domains/workspace/config/borders"
if [[ ! -d "$BORDERS_CONFIG_DIR" ]]; then
    # Fallback
    BORDERS_CONFIG_DIR="$HOME/dotfiles/domains/workspace/config/borders"
fi

if [[ -d "$BORDERS_CONFIG_DIR" ]]; then
    BORDERS_THEME="$BORDERS_CONFIG_DIR/themes/$THEME.sh"
    if [[ -f "$BORDERS_THEME" ]]; then
        ln -sf "$BORDERS_THEME" "$BORDERS_CONFIG_DIR/colors.sh"
        log_success "Updated Borders theme symlink"

        # Reload Borders
        if command -v borders >/dev/null 2>&1; then
            log_info "Reloading Borders..."
            # Re-run bordersrc to apply new colors
            "$BORDERS_CONFIG_DIR/bordersrc"
        fi
    else
        log_warn "Borders theme '$THEME' not found"
    fi
fi

# Update Zellij Theme
ZELLIJ_CONFIG_DIR="$HOME/.config/zellij"
if [[ -d "$ZELLIJ_CONFIG_DIR" ]]; then
    ZELLIJ_LAYOUT="$ZELLIJ_CONFIG_DIR/layouts/$THEME.kdl"
    if [[ -f "$ZELLIJ_LAYOUT" ]]; then
        # Update config to use the theme layout
        # Check if config.kdl is a symlink to dotfiles
        if [[ -f "$ZELLIJ_CONFIG_DIR/config.kdl" ]]; then
            if [[ -L "$ZELLIJ_CONFIG_DIR/config.kdl" ]]; then
                # It's a symlink, regenerate from template
                if [[ -n "$DOTFILES_ROOT" ]]; then
                    ZELLIJ_TEMPLATE="$DOTFILES_ROOT/domains/dev/config/zellij/config.kdl.template"
                else
                    ZELLIJ_TEMPLATE="$HOME/dotfiles/domains/dev/config/zellij/config.kdl.template"
                fi
                if [[ -f "$ZELLIJ_TEMPLATE" ]]; then
                    # Regenerate config.kdl with new theme
                    sed "s|{{HOME}}|${HOME}|g" "$ZELLIJ_TEMPLATE" | sed "s/default_layout \"[^\"]*\"/default_layout \"$THEME\"/" > "$ZELLIJ_CONFIG_DIR/config.kdl.tmp"
                    mv "$ZELLIJ_CONFIG_DIR/config.kdl.tmp" "$ZELLIJ_CONFIG_DIR/config.kdl"
                    log_success "Updated Zellij theme layout"
                else
                    # Fallback: direct edit
                    if [[ -w "$ZELLIJ_CONFIG_DIR/config.kdl" ]]; then
                        sed -i '' "s/default_layout \"[^\"]*\"/default_layout \"$THEME\"/" "$ZELLIJ_CONFIG_DIR/config.kdl"
                        log_success "Updated Zellij theme layout"
                    fi
                fi
            else
                # Not a symlink, edit directly
                if [[ -w "$ZELLIJ_CONFIG_DIR/config.kdl" ]]; then
                    sed -i '' "s/default_layout \"[^\"]*\"/default_layout \"$THEME\"/" "$ZELLIJ_CONFIG_DIR/config.kdl"
                    log_success "Updated Zellij theme layout"
                else
                    chmod 666 "$ZELLIJ_CONFIG_DIR/config.kdl"
                    sed -i '' "s/default_layout \"[^\"]*\"/default_layout \"$THEME\"/" "$ZELLIJ_CONFIG_DIR/config.kdl"
                    chmod 444 "$ZELLIJ_CONFIG_DIR/config.kdl"
                    log_success "Updated Zellij theme layout"
                fi
            fi
        fi
    else
        log_warn "Zellij layout '$THEME' not found"
    fi
fi

# Update tmux Theme
TMUX_THEMES_DIR="$HOME/.config/tmux/themes"
if [[ -d "$TMUX_THEMES_DIR" ]]; then
    TMUX_THEME="$TMUX_THEMES_DIR/$THEME.conf"
    if [[ -f "$TMUX_THEME" ]]; then
        ln -sf "$TMUX_THEME" "$TMUX_THEMES_DIR/current.conf"
        log_success "Updated tmux theme symlink"

        # Reload tmux if running
        if command -v tmux >/dev/null 2>&1 && tmux list-sessions >/dev/null 2>&1; then
            log_info "Reloading tmux..."
            tmux source-file ~/.config/tmux/tmux.conf 2>/dev/null || true
            log_success "Reloaded tmux with new theme"
        fi
    else
        log_warn "tmux theme '$THEME' not found"
    fi
fi

# Update and Reload Sketchybar
SKETCHYBAR_CONFIG_DIR="$DOTFILES_ROOT/domains/workspace/config/sketchybar"
if [[ ! -d "$SKETCHYBAR_CONFIG_DIR" ]]; then
    # Fallback
    SKETCHYBAR_CONFIG_DIR="$HOME/dotfiles/domains/workspace/config/sketchybar"
fi

if [[ -d "$SKETCHYBAR_CONFIG_DIR" ]]; then
    SKETCHYBAR_THEME="$SKETCHYBAR_CONFIG_DIR/themes/$THEME.lua"
    if [[ -f "$SKETCHYBAR_THEME" ]]; then
        ln -sf "$SKETCHYBAR_THEME" "$SKETCHYBAR_CONFIG_DIR/colors.lua"
        log_success "Updated Sketchybar theme symlink"

        if command -v sketchybar >/dev/null 2>&1; then
            # Force sketchybar to exit and restart
            pkill -f sketchybar 2>/dev/null || true
            sleep 0.5
            nohup sketchybar > /dev/null 2>&1 &
            log_success "Restarted Sketchybar"
        fi
    else
        log_warn "Sketchybar theme '$THEME' not found"
    fi
fi

# Reload WezTerm (usually automatic, but we can touch config to force)
# We assume wezterm config is at ~/.config/wezterm/wezterm.lua
WEZTERM_CONFIG="$HOME/.config/wezterm/wezterm.lua"
if [[ -f "$WEZTERM_CONFIG" ]]; then
    log_info "Reloading WezTerm..."
    touch "$WEZTERM_CONFIG"
fi

# Update Starship Palette (generated from template, gitignored)
STARSHIP_CONFIG="$DOTFILES_ROOT/domains/dev/config/starship/starship.toml"
if [[ ! -f "$STARSHIP_CONFIG" ]]; then
    STARSHIP_CONFIG="$HOME/.config/starship/starship.toml"
fi

if [[ -f "$STARSHIP_CONFIG" ]]; then
    if grep -q "^\[palettes\.$THEME\]" "$STARSHIP_CONFIG"; then
        sed -i '' "s/^palette = \"[^\"]*\"/palette = \"$THEME\"/" "$STARSHIP_CONFIG"
        log_success "Updated Starship palette"
    else
        log_warn "Starship palette '$THEME' not found"
    fi
fi

# Update VSCode/Cursor Theme
VSCODE_THEME="$(get_vscode_theme "$THEME")"
if [[ -n "$VSCODE_THEME" ]]; then
    for settings_file in \
        "$HOME/Library/Application Support/Code/User/settings.json" \
        "$HOME/Library/Application Support/Cursor/User/settings.json"; do
        if [[ -f "$settings_file" ]] || [[ -L "$settings_file" ]]; then
            # Resolve symlink if exists
            if [[ -L "$settings_file" ]]; then
                real_file=$(readlink "$settings_file")
                # Handle relative symlinks
                if [[ ! "$real_file" = /* ]]; then
                    real_file="$(dirname "$settings_file")/$real_file"
                fi
            else
                real_file="$settings_file"
            fi
            
            if [[ -f "$real_file" ]] && [[ ! -L "$real_file" ]]; then
                # Use sed for JSONC (JSON with comments) compatibility
                if grep -q '"workbench.colorTheme"' "$real_file"; then
                    sed -i '' "s/\"workbench.colorTheme\": *\"[^\"]*\"/\"workbench.colorTheme\": \"$VSCODE_THEME\"/" "$real_file"
                    log_success "Updated $(basename "$(dirname "$settings_file")")/settings.json"
                else
                    log_warn "workbench.colorTheme not found in $settings_file"
                fi
            fi
        fi
    done
else
    log_warn "VSCode theme mapping not found for '$THEME'"
fi

# Update Neovim Themes (all distributions)
NVIM_CONFIG_DIR="$DOTFILES_ROOT/domains/dev/config"
if [[ ! -d "$NVIM_CONFIG_DIR" ]]; then
    NVIM_CONFIG_DIR="$HOME/dotfiles/domains/dev/config"
fi

# LazyVim
LAZYVIM_COLORSCHEME="$NVIM_CONFIG_DIR/nvim-lazyvim/lua/plugins/colorscheme.lua"
if [[ -f "$LAZYVIM_COLORSCHEME" ]]; then
    sed -i '' "s/colorscheme = \"[^\"]*\"/colorscheme = \"$THEME\"/" "$LAZYVIM_COLORSCHEME"
    log_success "Updated LazyVim colorscheme"
elif [[ -d "$NVIM_CONFIG_DIR/nvim-lazyvim/lua/plugins" ]]; then
    cat > "$LAZYVIM_COLORSCHEME" << EOF
-- LazyVim colorscheme - auto-generated by theme-switch
return {
  { "catppuccin/nvim", name = "catppuccin", lazy = true },
  { "folke/tokyonight.nvim", lazy = true },
  { "rebelot/kanagawa.nvim", lazy = true },
  { "ellisonleao/gruvbox.nvim", lazy = true },
  { "Mofiqul/dracula.nvim", lazy = true },
  { "rose-pine/neovim", name = "rose-pine", lazy = true },
  { "sainnhe/everforest", lazy = true },
  { "navarasu/onedark.nvim", lazy = true },
  { "maxmx03/solarized.nvim", lazy = true },
  { "shaunsingh/nord.nvim", lazy = true },
  {
    "LazyVim/LazyVim",
    opts = {
      colorscheme = "$THEME",
    },
  },
}
EOF
    log_success "Created LazyVim colorscheme.lua"
fi

# NvChad (chadrc.lua)
NVCHAD_THEME="$(get_nvchad_theme "$THEME")"
NVCHAD_CHADRC="$NVIM_CONFIG_DIR/nvim-nvchad/lua/chadrc.lua"
if [[ -f "$NVCHAD_CHADRC" ]]; then
    sed -i '' "s/theme = \"[^\"]*\"/theme = \"$NVCHAD_THEME\"/" "$NVCHAD_CHADRC"
    log_success "Updated NvChad theme"
elif [[ -d "$NVIM_CONFIG_DIR/nvim-nvchad" ]]; then
    # Create chadrc.lua if it doesn't exist
    mkdir -p "$NVIM_CONFIG_DIR/nvim-nvchad/lua"
    cat > "$NVCHAD_CHADRC" << EOF
-- NvChad config - auto-generated by theme-switch
local M = {}

M.base46 = {
  theme = "$NVCHAD_THEME",
}

return M
EOF
    log_success "Created NvChad chadrc.lua with theme"
fi

# AstroVim (user colorscheme plugin)
ASTROVIM_USER="$NVIM_CONFIG_DIR/nvim-astrovim/lua/plugins/colorscheme.lua"
if [[ -f "$ASTROVIM_USER" ]]; then
    sed -i '' "s/colorscheme = \"[^\"]*\"/colorscheme = \"$THEME\"/" "$ASTROVIM_USER"
    log_success "Updated AstroVim colorscheme"
elif [[ -d "$NVIM_CONFIG_DIR/nvim-astrovim/lua/plugins" ]]; then
    cat > "$ASTROVIM_USER" << EOF
-- AstroVim colorscheme - auto-generated by theme-switch
return {
  { "catppuccin/nvim", name = "catppuccin", lazy = true },
  { "folke/tokyonight.nvim", lazy = true },
  { "rebelot/kanagawa.nvim", lazy = true },
  { "ellisonleao/gruvbox.nvim", lazy = true },
  { "Mofiqul/dracula.nvim", lazy = true },
  { "rose-pine/neovim", name = "rose-pine", lazy = true },
  { "sainnhe/everforest", lazy = true },
  { "navarasu/onedark.nvim", lazy = true },
  { "maxmx03/solarized.nvim", lazy = true },
  { "shaunsingh/nord.nvim", lazy = true },
  {
    "AstroNvim/astrocore",
    opts = {
      colorscheme = "$THEME",
    },
  },
}
EOF
    log_success "Created AstroVim colorscheme plugin"
fi

# Custom nvim (kickstart-based)
CUSTOM_COLORSCHEME="$NVIM_CONFIG_DIR/nvim-custom/lua/custom/plugins/colorscheme.lua"
if [[ -f "$CUSTOM_COLORSCHEME" ]]; then
    sed -i '' "s/vim.cmd.colorscheme '[^']*'/vim.cmd.colorscheme '$THEME'/" "$CUSTOM_COLORSCHEME"
    log_success "Updated Custom nvim colorscheme"
elif [[ -d "$NVIM_CONFIG_DIR/nvim-custom/lua/custom/plugins" ]]; then
    cat > "$CUSTOM_COLORSCHEME" << EOF
-- Custom nvim colorscheme - auto-generated by theme-switch
-- This file is generated automatically and should not be committed
return {
  load = function()
    vim.cmd.colorscheme '$THEME'
  end,
}
EOF
    log_success "Created Custom nvim colorscheme.lua"
fi

# Update macOS Wallpaper
WALLPAPER_DIR="$DOTFILES_ROOT/domains/workspace/assets/background"
if [[ ! -d "$WALLPAPER_DIR" ]]; then
    WALLPAPER_DIR="$HOME/dotfiles/domains/workspace/assets/background"
fi

if [[ -d "$WALLPAPER_DIR" ]]; then
    # Check for theme wallpaper (jpg, png, or heic)
    WALLPAPER=""
    for ext in jpg jpeg png heic; do
        if [[ -f "$WALLPAPER_DIR/$THEME.$ext" ]]; then
            WALLPAPER="$WALLPAPER_DIR/$THEME.$ext"
            break
        fi
    done

    if [[ -n "$WALLPAPER" ]]; then
        if command -v desktoppr >/dev/null 2>&1; then
            desktoppr "$WALLPAPER"
            log_success "Updated wallpaper"
        else
            log_warn "desktoppr not found"
        fi
    else
        log_warn "Wallpaper for '$THEME' not found"
    fi
fi

# Update Userstyles (for Stylus browser extension)
USERSTYLES_DIR="$DOTFILES_ROOT/domains/system/userstyles"
if [[ ! -d "$USERSTYLES_DIR" ]]; then
    USERSTYLES_DIR="$HOME/dotfiles/domains/system/userstyles"
fi

if [[ -d "$USERSTYLES_DIR" ]]; then
    # Regenerate userstyles for the new theme
    GENERATE_SCRIPT="$USERSTYLES_DIR/scripts/generate-userstyles.sh"
    if [[ -f "$GENERATE_SCRIPT" ]]; then
        log_info "Generating userstyles for $THEME..."
        if bash "$GENERATE_SCRIPT" "$THEME" >/dev/null 2>&1; then
            log_success "Generated userstyles for $THEME"
        else
            log_warn "Userstyles generation failed (non-critical)"
        fi
    fi

    # Update userstyle symlinks for each site
    for site_dir in "$USERSTYLES_DIR"/*; do
        if [[ -d "$site_dir" ]]; then
            SITE_NAME=$(basename "$site_dir")
            # Skip templates, scripts, and vars directories
            if [[ "$SITE_NAME" == "templates" || "$SITE_NAME" == "scripts" || "$SITE_NAME" == "vars" ]]; then
                continue
            fi

            USERSTYLE_FILE="$site_dir/$THEME.user.css"
            ACTIVE_LINK="$site_dir/active.user.css"

            if [[ -f "$USERSTYLE_FILE" ]]; then
                # Use relative symlink for better portability
                (cd "$site_dir" && ln -sf "$THEME.user.css" "active.user.css")
                log_success "Updated $SITE_NAME userstyle symlink"
            else
                log_warn "Userstyle for '$THEME' not found in $SITE_NAME"
            fi
        fi
    done

    # Generate Stylus import.json for the theme
    IMPORT_SCRIPT="$USERSTYLES_DIR/scripts/generate-stylus-import.sh"
    if [[ -f "$IMPORT_SCRIPT" ]]; then
        if bash "$IMPORT_SCRIPT" "$THEME" >/dev/null 2>&1; then
            log_success "Generated Stylus import.json for $THEME"
            log_info "Import into Stylus: $USERSTYLES_DIR/import.json"
        fi
    fi

    log_info "Note: For first-time setup, import import.json into Stylus"
    log_info "Stylus will auto-reload when theme changes via symlinks"
fi

log_success "Theme switched successfully!"
